# Модуль учёта выходных

Полностью изолированный модуль для управления заявками на выходные дни в Telegram боте.

## Функциональность

### Команды для пользователей

#### Подача заявок на выходной
- `/выходной ГГГГ-ММ-ДД причина` - подать заявку на выходной день (классический формат)
- `/в дата причина` - подать заявку с гибким форматом даты:
  - `/в 24 причина` - если до 24 числа — текущий месяц; если >=24 — следующий месяц
  - `/в 24.08 причина` или `/в 24 08 причина` - 24-е указанного месяца (в этом или следующем году, если месяц уже прошёл)
  - `/в 24.08.2025 причина` или `/в 24 08 2025 причина` - точная дата с годом

#### Просмотр выходных
- `/вых` - показать будущие одобренные выходные
- `/всевых`, `/вс`, `/список` - показать все одобренные выходные

#### Поиск свободных дат
- `/сд`, `/даты` - показать 7 ближайших свободных дат для выходных

### Возможности администратора
- Получение уведомлений о новых заявках
- Одобрение/отклонение заявок через интерактивные кнопки
- Автоматическая отправка уведомлений пользователям о статусе заявки

### Новые возможности
- **Проверка конфликтов дат**: система автоматически проверяет, что дата не занята другой одобренной заявкой
- **Гибкий парсинг дат**: поддержка различных форматов ввода даты с интеллектуальным определением месяца и года
- **Поиск свободных дат**: автоматический поиск ближайших доступных дат для подачи заявки

## Конфигурация

### holidays_config.py
```python
HOLIDAYS_CHAT_ID = -1001956037680    # ID чата
HOLIDAYS_THREAD_ID = 4               # ID топика
HOLIDAYS_ADMIN_IDS = [566901876]     # Список админов
HOLIDAYS_DB_PATH = "holidays_db.json" # Путь к БД
```

## Структура файлов

- `holidays_config.py` - конфигурация модуля
- `holidays.py` - основная логика
- `holidays_db.json` - локальная база данных
- `test_holidays.py` - тесты модуля
- `demo_holidays.py` - демонстрация функций

## Интеграция

В `bot.py` добавлена одна строка интеграции:

```python
from holidays import register_holiday_handlers
register_holiday_handlers(bot)
```

## Ограничения безопасности

- Работает только в указанном чате (-1001956037680)
- Работает только в указанном топике (4)
- Только указанный администратор (566901876) может одобрять заявки
- Все команды и обработчики проверяют эти ограничения

## База данных

JSON структура в `holidays_db.json`:

```json
{
  "requests": {
    "1": {
      "user_id": 12345,
      "date": "2024-12-31",
      "reason": "семейные обстоятельства",
      "status": "pending",
      "created_at": "2024-08-22T14:30:00",
      "processed_by": null,
      "processed_at": null
    }
  },
  "users": {
    "12345": {
      "username": "user123",
      "first_name": "Иван",
      "last_name": "Петров",
      "last_update": "2024-08-22T14:30:00"
    }
  },
  "next_id": 2
}
```

## Статусы заявок

- `pending` - ожидает рассмотрения
- `approved` - одобрена
- `rejected` - отклонена

## Примеры использования

### Подача заявки (классический формат)
```
/выходной 2024-12-31 семейные обстоятельства
```

### Подача заявки (гибкий формат)
```
/в 24 семейные обстоятельства
/в 15.08 отпуск
/в 25 12 2025 новогодние праздники
```

### Просмотр будущих выходных
```
/вых
```

### Просмотр всех выходных
```
/всевых
/вс
/список
```

### Поиск свободных дат
```
/сд
/даты
```

## Тестирование

Запуск тестов:
```bash
python3 test_holidays.py
```

Демонстрация возможностей:
```bash
python3 demo_holidays.py
```

## Технические особенности

- Полная изоляция от основного функционала бота
- Thread-safe операции с базой данных
- Валидация входных данных
- Обработка ошибок и логирование
- Поддержка Unicode (русский язык)
- Production-ready код